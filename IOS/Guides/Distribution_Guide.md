# Store Distribution guide

Здесь описан процесс конфигурации проекта перед выгрузкой в AppStore, а также действия разработчика при выгрузке. Можно считать это чек-листом на новом для вас проекте: необходимо выполнить действия, указанные ниже или убедиться в том что это уже было сделано до вас.

## Добавление в аккаунт команды заказчика

Все действия в личном кабинете разработчика (developer.apple.com) и в AppstoreConnect должны происходить из под аккаунта компании, добавленного в аккаунт команды заказчика.

**В аккаунт заказчика запрещено добавлять персональные аккаунты разработчиков.** Для этих целей есть аккаунт компании - [apple@touchin.ru](apple@touchin.ru)

Добавить аккаунт необходимо в двух местах:

### [developer.apple.com](https://developer.apple.com)

Добавляется с ролью админа. После отправки приглашения iOS lead или CTO могут принять это приглашение на почте.

### [appstoreconnect.apple.com](https://appstoreconnect.apple.com)

Добавляется с несколькими ролями - *App Manager, Customer Support, Sales*. После отправки приглашения iOS lead или CTO могут принять это приглашение на почте.

## Сертификаты

В проекте должна быть папка Certificates. Если нужного сертификата там нет - его нужно создать. Или получить от клиента уже существующий сертификат, в случае если создать новый не удается: нельзя создать больше трёх distribution сертификатов. В последнем случае вопрос решается через лида (и, возможно, менеджера проекта). С provisioning профайлом та же история - его нужно создать либо просто скачать с портала developer.apple.com. Созданные / обновленные / полученные файлы необходимо сохранить в папку Certificates.

При оформлении CertificateRequest необходимо указывать в поле CommonName читаемое и понятное краткое название сертификата. Пример: *LicardStorePushCert* или *BSPBEnterprisePushCert* или *CryptonatorStoreCert*.

Папка Certificates проекта должна содержать в минимальной конфигурации:

- сертификат для подписывания сборки для стора в виде файла p12
- актуальный distribution provisioning profile, для выгрузки в стор
- файл Readme.md, описывающий содержимое папки и содержащий пароли к сертификатам.

Также, в эту папку (и в файл Readme) подлежат складыванию **все** пуш-сертификаты с указанием паролей и bundle-id, для которых они созданы.

[Пример оформления](https://github.com/TouchInstinct/Licard-ios/blob/master/certificates/README.md)

## Конфигурация проекта

Сборка для стора осуществляется разработчиком проекта локально. Для этого должна быть настроена конфигурация AppStore. Конфигурация AppStore создается путем копирования любой **Enterprise...Release** конфигурации.

После копирования:

- для новой конфигурации указать корректный Product Bundle Identifier в BuildSettings
- для новой конфигурации указать корректный Provisioning Profile
- убедиться в том, что Code Signing Identity для новой конфигурации установлен в *iPhone Distribution...*
- установить конфигурацию для архивации: Edit Scheme -> Archive -> Build Configuration -> выбрать только что созданную конфигурацию.
- добавить конфигурацию в Podfile + выполнить `pod install`

Не забыть про:

- корректные entitlements для новой конфигурации
- корректные флаги компиляции (например, для определения Api endpoint URL)

## Сборка

На этапе сборки не забыть:

- указать корректный номер версии (предварительно созданной в AppStoreConnect)
- если сборка предназначена для ревью, а не только для TestFlight - указать номер сборки, которую заапрувил отдел QA
- указать аналогичные номера версий и сборок во всех Extension таргетах

## AppStoreConnect

- не забыть поставить *Manually release this version*, в случае если не оговорено иное поведение

## В момент релиза

В том случае, если сборка успешно прошла ревью и попала в стор, необходимо поставить тэг с версией в гите.

## Further reading

- [Инструкция по выкладыванию в стор](PublishAppInStore/PublishAppInStore.md)