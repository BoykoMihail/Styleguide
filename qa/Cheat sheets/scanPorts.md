# Сканирование портов

### Установка необходимых утилит

1.   Nmap

     Скачиваем с [офф сайта](https://nmap.org/download.html) и устанавливаем.
     Помимо самой утилиты в пакет входит GUI для работы с ней - Zenmap.

2. Tor

      Быстрая установка в маке, используя homebrew - в терминале вводим: 

        brew install tor
   
3. Proxychains-ng

      При установки через homebrew могут возникнуть проблемы с файлом конфигурации. Рабочий способ установить, используя git в терминале:
        
        git clone https://github.com/rofl0r/proxychains-ng
        cd proxychains-ng
        ./configure --prefix=/usr/local --bindir=/usr/local/bin --libdir=/usr/local/lib --fat-binary
        make
        make install

### Тренировка на виртуальной машине

Настройка связи на примере VirtualBox, на других vm делается аналогично.

1. Открываем настройки VM, вкладка Сеть

2. Добавляем второй сетевой адаптер, тип "Виртуальный адаптер хоста"

3. Сохраняем изменения, запускаем VM

4. Открываем терминал, делаем команду ipconfig/ifconfig в зависимости от OS и смотрим свой IP у второго сетевого адаптера (например 192.168.56.101)

5. Если на VM включен брандмауэр - требуется создать правило на разрешение входящих подключений из локальной подсети - либо для ip хоста, либо для всего диапазона подсети, в данном случае 192.168.56.1 - 192.168.56.255

6. Проверяем наличие связи пингуя с хоста виртуалку и наоборот, потери пакетах должны отсутствовать

После установки связи между хостом и виртуалкой можно приступать к сканированию портов виртуалки:

1. Используя Zenmap - интерфейс интуитивный, в поле Target вводим IP виртуалки, в Profile выбираем нужный тип сканирования и изучаем по [доке](https://nmap.org/man/ru/), что означает каждый параметр в поле Command.

2. Используя nmap напрямую в терминале. Для запуска сканирования вводится комманда, аналогичная полю Command в Zenmap. Пример:

        nmap -sT -PN -sV --open -n -p 80 192.168.56.101

###  Проверка на отсутствие текущего IP в пакетах, отправляемых напрямую к целевой машине

1. Открыть 2 окна терминала

2. Пишем лог без использования proxychains.

   В первом окне ввести:

          sudo tcpdump -w no_tor.cap
   
   Во втором окне запустить сканирование без использования proxychains, ввести целевой IP:
   
          nmap -sT -PN -sV --open -n -p 80 127.0.0.1
   
   Когда сканирование закончится - остановить(Ctrl+C) tcpdump в первом окне.

3. Пишем лог с использованием proxychains + tor.

   В первом окне ввести:

          sudo tcpdump -w with_tor.cap
   
   Во втором окне запустить сканирование с использование proxychains, ввести целевой IP:
   
          proxychains4 nmap -sT -PN -sV --open -n -p 80 127.0.0.1
   
   Когда сканирование закончится - остановить tcpdump в первом окне.

4. Теперь, в двух файлах с логами, ищем следы общения с целевым хостом:

          sudo tcpdump -nS -c 10 -r no_tor.cap "host 127.0.0.1"
          sudo tcpdump -nS -c 10 -r with_tor.cap "host 127.0.0.1"
   
   Если в файле no_tor.cap - есть список приема/передачи пакетов на целевой хост, а в файле with_tor.cap - нет, то все настроено правильно.

### Сканирование портов реальной машины

**Сканирование производить только с помощью ProxyChains-NG + Tor, иначе провайдер может забанить.**

Перед сканированием обязательно проверить, что IP не светится в логах по инструкции выше.

Параметры комманды nmap, которые стоит использовать:

1. **-sT** - TCP сканирование, прописывать обязательно, т.к. ProxyChains умеет работать только с TCP.

2. **-Pn** - не использовать пинг сканирование

3. **--open** - показывать только открытые (или возможно открытые) порты, для удобства оценки результата

4. **-n** - никогда не производить обратное преобразование DNS имен. В некоторых случаях, ответ от целевого хоста может содержать URL, а не IP. Для дополнительной безопасности следует использовать этот параметр.

5. **-p 1-1024** - ограниченный диапазон сканируемых портов. Через тор, сканирование 1024 портов занимает 2-2.5 часа. Для увеличения скорости сканирования есть возможность запускать сканер в нескольких сессиях параллельно. 

6. **-v -v -v** - каждое -v увеличивает количество информации в отчете, при трех -v - отображается максимум информации.


Пример готовой команды:
        
        proxychains4 nmap -sT -Pn -sV --open -n -v -v -v -p 1-1024 127.0.0.1

### Скрипт для автоматического сканирования диапазона портов

[Ссылка](https://drive.google.com/open?id=1sBrLpf34OuN4ubYtgKBWASmapm968YBN) на скрипт.

Перед запуском скрипта следует включить tor и проверить что в логах не светится IP.

Требуется отредактировать скрипт для конкретной задачи, а именно:

* min - начальный порт диапазона, минимальное значение - 0
* max - последний порт диапазона, максимальное значение - 65535
* count -  кол-во одновременных сессий

После запуска скрипта, в дирректории расположения скрипта, создаются файлы, с отчетом по каждой из сессий. Требуется дождаться выполнения скрипта. 

После выполнения скрипта, в дирректории скрипта создастся файл result, в котором будет список всех открытых портов.

### Виртуальная машина с настроенными утилитами

Инструкция по использованию:

1) [Скачать](https://www.dropbox.com/s/90t1hld12uwa8g6/Kali_linux.ova?dl=0) виртуальную машину
2) Запустить в программе виртуализации(VMWare, VMBox и т.д.), user/pass: root/0000
3) Если требуется изменить стандартные настройки скрипта - требуется зайти в папку расположения скрипта /Домашняя папка/Scaner, открыть scaner.sh и подредактировать параметры. Стандартные настройки:
     * Начальный порт - 0
     * Конечный порт - 65535
     * Количество сессий - 60
     
4) Открыть терминал, запустить скрипт - в параметре передать целевую URL:

          cd Scaner
          ./scaner.sh google.ru

4) При выполнении скрипта, в папке /Домашняя папка/Scaner создается папка, название которой целевая URL. Внутри нее файл result со списком найденных открытых портов и папка Sessions - в которой список отчетов по каждой сессии.
