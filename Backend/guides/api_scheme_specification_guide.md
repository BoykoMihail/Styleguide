# Спецификация языка описания API
## Структура документа

* [Схема](#Схема)
     * [Формат](#Формат)
     * [Стандартные типы данных](#Стандартные-типы-данных)
     * [Типы данных, определённые в схеме](#Типы-данных-определённые-в-схеме)
     * [Формат описания имени типа](#Формат-описания-имени-типа)
     * [Формат описания имени класса с шаблонным типом](#Формат-описания-имени-класса-с-шаблонным-типом)
     * [Файловая структура](#Файловая-структура)
     * [Описание типа данных](#Описание-типа-данных)
     * [Классы](#Классы)
     * [Перечисления](#Перечисления)
     * [Расширение полей](#Расширение-полей)
     * [Шаблонные классы](#Шаблонные-классы)
     * [Методы](#Методы)


## Схема

### Формат
Представленный здесь формат описания RESTful API представляет из себя набор JSON файлов имеющих определённый формат и соотвествующих стандартам JSON.

### Стандартные типы данных
|Формат|Комментарий|
|:-:|:--|
|Bool|Булевский тип данных.|
|Int|Целое число со знаком.|
|Long|Длинное целое число со знаком.|
|Double|Вещественное число с плавающей запятой.|
|Decimal|Числовой тип данных, который используется в финансовых расчетах и расчетах с участием денежных единиц.|
|String|Строковый тип данных.|
|DateTime|Дата и время в определённом формате. Может не содержать времени.|
|Date|Дата в определённом формате.|
|DateTimeTimestamp|Дата и время в формате timestamp.|
|Color|HEX представление цвета в строковом формате.|
|StringDecimal|Вещественное число с плавающей запятой в строковом формате.|
|Url|URL в строковом формате.|
|T[]|Массив из значений произвольного типа T.|
|Map\<T1,T2\>|Ассоциативный массив с ключами типа T1 и значениями типа T2.|

### Типы данных, определённые в схеме
|Формат|Комментарий|
|:-:|:--|
|EnumName|Перечисление. Определяет возможный набор значений и их тип.|
|ClassName|Класс, опредёленный в API, либо имя шаблона в шаблонном классе.|

### Формат описания имени типа
К имени типа применяются правила именования типов в объектно-ориентированных языках программирования. Имя типа должно быть уникальным в пределах схемы.

### Формат описания имени класса с шаблонным типом
В дополнение к [формату описания имени типа](#Формат-описания-имени-типа), у имени класса с шаблонным типом может быть указан один или несколько шаблонных типов. Шаблонные типы указываются в угловых скобках после имени класса и перечисляются через запятую и пробел.

### Файловая структура
В корне описания схемы API должны располагаться две папки:

- `structures` - описание типов данных, которые определяются в контексте этого API.
- `methods` - описание запросов к серверу.

Внутри папки `structures` располагаются ещё две папки:

- `classes` - классы схемы API.
- `enums` - перечисления схемы API.

#### Пример
```
~/Projects/sber-cards-api
├── main.json
├── generation.meta.json
├── methods
│   ├── card
│   │   └── listing.json
│   ├── transaction
│   │   └── listing.json
│   └── user
│       ├── login.json
│       └── logout.json
└── structures
    ├── classes
    │   ├── BaseResponse.json
    │   ├── Card.json
    │   ├── CardListing.json
    │   ├── Session.json
    │   ├── Transaction.json
    │   ├── TransactionListing.json
    │   └── UserLogoutResponse.json
    └── enums
        ├── ApiError.json
        └── CardStatus.json
```

#### Общая информация о схеме
За общее описание API отвечает файл `main.json`, который располагается в корне описания схемы api.

##### Содержание файла `main.json`
* `title` - название схемы api.
* `base_url` - базовый URL для схемы api.
* `version` - версия схемы api.
* `author` - автор докумета.
* `response_result_selector` - путь к полю с результатом ответа от сервера.
	* `class_name` - имя класса, в который содержится ответ от сервера.
	* `field_name` - имя поля внутри класса, которое содержит ответ от сервера.
* `response_error_selector` - путь к полю с ошибкой от сервера.
	* `class_name` - имя класса, в котором содержится ошибка от сервера.
	* `field_name` - имя поля внутри класса, которое содержит ошибку от сервера.

Все описанные поля являются обязательными.

###### Пример
```json
{
    "title": "Sber-cards-api",
    "base_url": "https://build.touchin.ru/sbercards2/api/",
    "version": "17.0",
    "author": "Петр Петров",
    "response_result_selector": {
        "class_name": "BaseResponse",
        "field_name": "result"
    },
    "response_error_selector": {
        "class_name": "BaseResponse",
        "field_name": "error_code"
    }
}
```
> во время генерации документации в файл main.json добавляется строковое поле "build_version" в которой указан номер сборки. При каждой генерации значение build_version инкрементируется

### Описание типа данных
Тип данных описывается объектом в формате JSON. У такого объекта есть поля описывающие как сам тип данных, так и набор полей этого типа.

Всего есть три основных типа данных:

- [Стандартные](#Стандартные-типы-данных)
- [Классы](#Классы)
- [Перечисления](#Перечисления)

#### Поля, описывающие тип
|Название|Обязательность|Значение по умолчанию|Комментарий|
|:-:|:-:|:-:|---|
|name|да|-|[Имя класса](#Формат-описания-имени–класса-с-шаблонным-типом) или [имя примитивного типа данных](#Стандартные-типы-данных). В имени класса могут содержаться шаблонные аргументы у которых нет реализации.|
|parent|нет|-|[Имя родительского класса](#Формат-описания-имени–класса-с-шаблонным-типом). В качестве шаблонных аргументов может принимать шаблонные типы дочернего класса или конкретные типы.|
|description|нет|-|Текстовое описание класса.|
|fields|нет|[]|Список объектов, описывающих поля класса.|
|storageAttributes|нет|-|Объект ClassStorageAttributes, описывающий параметры хранения модели.|

#### ClassStorageAttributes
|Название|Обязательность|Комментарий|
|:-:|:-:|---|
|primaryKeys|нет|Массив полей, входящих в первичный ключ таблицы. Может отсутствовать при наличии хотя бы одного поля с параметром autoGenerate = true.|
|tableName|нет|Имя таблицы.|

#### Поля объекта, описывающего поле класса
|Название|Обязательность|Значение по умолчанию|Комментарий|
|:-:|:-:|:-:|---|
|json_name|да|-|Имя, которое будет использоваться при сериализации / десериализации поля класса.|
|name|нет|Значение поля `json_name`, переведенного в camelCase.|Имя, которое будет использоваться для поля внутри сгенерированных классов.|
|optional|нет|false|Флаг, который показывает, может ли поле отсутствовать при сериализации или десериализации|
|nullable|нет|false|Флаг, который показывает, может ли поле иметь null значение.|
|description|нет|-|Текстовое описание поля|
|include_in_doc|нет|-|Флаг для включения или исключения класса из документации.|
|type|нет|-|[Описание типа данных](#описание-типа-данных)|
|autoGenerate|нет|false|Признак того, что поле является автогенерируемым первичным ключом. Взаимоисключающий параметр с primaryKeys в структуре ClassStorageAttributes.

### Классы
Все сущности предметной области и сложные структуры данных описываются как типы данных и располагаются в папке `classes`.

##### Пример описания класса
```json
{
    "name": "Transaction",
    "description": "Транзакция",
    "fields": [
        {
            "json_name": "id",
            "description": "Идентификатор",
            "type": {
                "name": "String"
            }
        },
        {
            "json_name": "amount",
            "description": "Сумма",
            "type": {
                "name": "Decimal"
            }
        },
        {
            "json_name": "checkUrl",
            "description": "Url чека транзакции",
            "type": {
                "name": "Url"
            }
        },
        {
            "json_name": "transactionDate",
            "description": "Дата транзакции в формате timestamp",
            "type": {
                "name": "DateTimeTimestamp"
            }
        }
    ]
}
```

### Перечисления
Каждое поле, имеющее некоторый ограниченный список идентификаторов определяется через перечисление и располагается в папке `enums`.

#### Поля, описывающие перечисление
|Название|Обязательность|Значение по умолчанию|Комментарий|
|:-:|:-:|:-:|---|
|name|да|-|[Имя типа](#Формат-описания-имени-типа).|
|values_type|да|-|Тип значений перечисления. Возможные значения: `Int`, `String`.|
|description|нет|-|Текстовое описание перечисления.|
|values|да|-|Список объектов, описывающих возможные значения перечисления.|
|allowed_values|нет|Все значения `json_name` в массиве `values`.|Допустимые значения в определённом контексте использования.|
|storable|нет|false|Признак того, что значения данного перечисления используются для хранения в БД.|

#### Поля объекта, описывающего значение перечисления
|Название|Обязательность|Значение по умолчанию|Комментарий|
|:-:|:-:|:-:|---|
|json_name|да|-|Имя, которое будет использоваться при сериализации / десериализации значения перечисления.|
|name|нет|Значение поля json_name.|Имя, которое будет использоваться для значения перечисления внутри сгенерированных перечислений.|
|description|нет|-|Текстовое описание значения перечисления.|

##### Пример описания перечисления
```json
{
    "name": "CardStatus",
    "values_type": "String",
    "description": "Статус карты",
    "values": [
        {
            "json_name": "active",
            "description": "Активна"
        },
        {
            "json_name": "blocked",
            "description": "Заблокирована"
        }
    ]
}
```

### Расширение полей
Поля объектного типа могут быть расширены. Механизм расширения подразумевает, что свойства могут быть переопределены или добавлены к существующему объекту в родительском классе.

#### Пример переопределения типа и расширение поля
```json
{
    "name": "Transaction",
    "description": "Транзакция",
    "fields": [
        {
            "json_name": "id",
            "optional": false,
            "nullable": false,
            "description": "Идентификатор",
            "type": {
                "name": "String"
            }
        },
        {
            "json_name": "card",
            "optional": false,
            "nullable": false,
            "description": "Карта, по которой была проведена транзакция",
            "type": {
                "name": "StringNumberCard",
                "parent": "Card",
                "fields": [
                    {
                        "json_name": "number",
                        "description": "Номер карты в строковом формате",
                        "type": {
                            "name": "String"
                        }
                    }
                ]
            }
        }
    ]
}
```

В примере был переопределён тип поля `card` и расширено поле `fields`. Таким образом в поле `fields` добавился ещё один объект описывающий поле класса `number`.

### Шаблонные классы
Шаблонные классы - классы содержащие в себе поля, тип которых может быть переопределен в реализациях данного класса или в дочерних классах.

#### Пример описания шаблонного класса
```json
{
    "name": "BaseResponse<TResult>",
    "fields": [
        {
            "json_name": "result",
            "nullable": true,
            "description": "В случае ошибки содержит null. В случае успеха содержит результат вызова метода.",
            "type": {
                "name": "TResult"
            }
        },
        {
            "json_name": "error_code",
            "description": "В случае ошибки содержит код ошибки 1..999. В случае успеха содержит 0.",
            "type": {
                "name": "ApiError"
            }
        },
        {
            "json_name": "error_message",
            "nullable": true,
            "description": "В случае ошибки содержит текстовое описание ошибки. В случае успеха содержит null.",
            "type": {
                "name": "String"
            }
        }
    ]
}
```

В данном примере класс `BaseResponse` явно указывает в своём названии то, что у него есть шаблонные типы, которые используются в его полях.

### Методы
Взаимодействие между клиентом и сервером описывается через методы API и располагается в папке `methods`.

#### Поля описывающие метод API
|Название|Обязательность|Значение по умолчанию|Комментарий|
|:-:|:-:|:-:|---|
|name|да|-|Название метода API. Должно быть уникальным в пределах папки.|
|url|да|-|Относительный путь к ресурсу на сервере.|
|type|нет|POST|Тип HTTP-запроса.|
|priority|нет|0|Приоритет метода в пределах группы методов.|
|description|нет|-|Текстовое описание метода.|
|request\_query\_parameters|нет|-|Query-параметры. [Объект описания типа данных](#описание-типа-данных).|
|request\_headers\_type|нет|-|Заголовки запроса. [Объект описания типа данных](#описание-типа-данных).|
|body_type|нет|-|Body запроса. [Объект описания типа данных](#описание-типа-данных).|
|response\_headers\_type|нет|-|Заголовки ответа. [Объект описания типа данных](#описание-типа-данных).|
|response_type|нет|-|Body ответа. [Объект описания типа данных](#описание-типа-данных).|

##### Пример описания метода API
```json
{
    "name": "CardListingRequest",
    "url": "/card/listing/",
    "type": "GET",
    "priority": "3",
    "description": "Список карт",
    "body_type": {
        "name": "Session"
    },
    "request_headers_type": {
      "name": "CardListingRequestHeaders",
      "fields": [
         {
            "json_name": "Authorization",
            "type": {
               "name": "String"
            }
         }
      ]
    },
    "request_query_parameters": {
      "name": "CardListingRequestParams"
    },
    "response_headers_type": {
      "name": "CardListingResponseHeaders"
    },
    "response_type": {
        "name": "CardListingResponse",
        "parent": "BaseResponse<CardListing>",
        "fields": [
            {
                "json_name": "result",
                "type": {
                    "name": "CardListing"
                }
            },
            {
                "json_name": "error_code",
                "type": {
                    "name": "ApiError",
                    "allowed_values": [
                        1,
                        2
                    ]
                }
            }
        ]
    }
}
```

### Содержание файла `generation.meta.json`
Файл содержит метаинформацию, необходимую для генерации моделей и документации.

|Название|Обязательность|Значение по умолчанию|Комментарий|
|:-:|:-:|:-:|---|
|methods_groups|да|-|Приоритезация методов и групп методов, информация о группах.|
|versioning_enabled|нет|true|Используется ли версионирование.|
|push_enabled|нет|true|Используются ли пуши.|
|java_method_generation_enabled|нет|true|Надо ли генерировать код методов на Java.|
|ios_method_generation_enabled|нет|true|Надо ли генерировать код методов под iOS.|
|kotlin_method_generation_enabled|нет|true|Надо ли генерировать код методов на Kotlin.|

Данные о группах методов:

|Название|Обязательность|Значение по умолчанию|Комментарий|
|:-:|:-:|:-:|---|
|group_name|да|-|Название группы, соответствует названию папки с группой методов.|
|priority|нет|0|Приоритет группы.|
|title|нет|-|Отображаемое в документации название группы.|
|description|нет|-|Описание группы.|
|base_url|нет|-|Базовая url группы методов. Если не задана, то используется значение base_url из файла main.json|

###### Пример
```json
{
    "methods_groups": [
        {
            "group_name": "user",
            "priority": 1,
            "title": "Методы для работы с пользователем",
            "description": "Методы для получения и обновления данных пользователя",
            "base_url": "https://users.touchin.ru/"
        }
    ],
    "versioning_enabled": false,
    "push_enabled": false,
    "java_method_generation_enabled": false
}
```
